name: Smoke
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Apex front door
        run: |
          set -euo pipefail
          curl -sI https://dhkalign.com | head -n1 | grep -E ' 200 '

      - name: www redirects to apex
        run: |
          set -euo pipefail
          code=$(curl -s -o /dev/null -w '%{http_code}' "https://www.dhkalign.com/test?q=1")
          [ "$code" = "301" ] || { echo "Expected 301, got $code"; exit 1; }

- name: Edge version (CI-safe)
  run: |
    set -euo pipefail
    OUT=$(curl -fsS https://edge.dhkalign.com/version || true)
    echo "--- edge /version ---"
    echo "$OUT" | jq . || echo "$OUT"
    echo "$OUT" | jq -e '(.sha? != null) or (.data?.sha? != null)'
      - name: Backend health (via domain)
        run: |
          set -euo pipefail
          curl -fsS https://backend.dhkalign.com/health | jq -e '(.status?=="ok") or (.ok?==true)'

      - name: Free translate (1) via Worker
        run: |
          set -euo pipefail
          OUT="$(curl -fsS --get "https://edge.dhkalign.com/api/translate" --data-urlencode "q=Rickshaw pabo na")"
          echo "$OUT" | jq . || true
          echo "$OUT" | jq -e 'has("translation") or has("output") or has("result") or has("data")'

      - name: Free translate (2) via Worker (cache ok)
        run: |
          set -euo pipefail
          curl -fsS --get "https://edge.dhkalign.com/api/translate" --data-urlencode "q=Rickshaw pabo na" \
          | jq -e 'has("translation") or has("output") or has("result") or has("data")'
